<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>MBTI 테스트</title>
    <style>
        @font-face {
            font-family: 'Ownglyph_ParkDaHyun';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2411-3@1.0/Ownglyph_ParkDaHyun.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            text-align: center;
            font-family: Ownglyph_ParkDaHyun, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 20px;
        }

        .progress-container {
            width: 80%;
            background-color: #C6B096;
            border-radius: 5px;
            margin-top: 15px;
            text-align: left;
            position: relative;
        }

        .progress-bar {
            height: 8px;
            width: 0%;
            background-color: #683611;
            border-radius: 5px;
            transition: width 0.3s;
        }

        .progress-text {
            margin-bottom: 2rem;
            margin-top: 2rem;
            color: #6B3F19;
        }

        .question-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 80%;
            text-align: center;
        }

        .question {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .button-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .answer-button {
            display: block;
            width: 80%;
            height: 5rem;
            margin: 10px auto;
            padding: 10px;
            font-size: 20px;
            background-color: #F8F19F;
            border-color: #683611;
            border-radius: 20px;
            cursor: pointer;
            font-family: Ownglyph_ParkDaHyun, sans-serif;
        }

        .answer-button:hover {
            background-color: #FDD021;
        }

        @media (max-width: 1000px) {
            .container {
                width: 100%;
                height: 100vh;
                max-width: none;
                margin: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-between;
                padding-bottom: 2rem;
            }

            .progress-container {
                width: 80%;
                background-color: #C6B096;
                border-radius: 5px;
                margin-top: 20px;
                text-align: left;
                position: relative;
            }

            .progress-bar {
                height: 18px;
                width: 0%;
                background-color: #683611;
                border-radius: 5px;
                transition: width 0.3s;
            }

            .progress-text {
                margin-bottom: 2rem;
                margin-top: 2rem;
                font-size: 35px;
                color: #6B3F19;
            }

            .question-wrapper {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: 80%;
                text-align: center;
            }

            .question {
                font-size: 40px;
                font-weight: bold;
                margin-bottom: 20px;
            }

            .button-section {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 4rem;
            }

            .answer-button {
                display: block;
                width: 80%;
                height: 10rem;
                margin: 10px auto;
                padding: 10px;
                font-size: 40px;
                background-color: #F8F19F;
                border-color: #683611;
                border-radius: 20px;
                cursor: pointer;
            }
        }
    </style>
</head>

<script th:inline="javascript">
    //질문 총 갯수 하드코딩 ( 추후에 총 쿼리개수/3 한 값을 출력해오는 sql문 추가 고려중 )
    let totalQuestions = 12;


    function nextQuestion(button) {
        let testNum = document.getElementById("testNum");
        let curVal = parseInt(testNum.value);
        // 해당 hidden값과 일치하는 모든 알파벳 +1하는 함수 호출
        let getMbti = button.getAttribute("data-mbti");
        setMbti(getMbti);

        axios.get('getList', { params: { testNum: testNum.value } })
            .then(response => {
                let questions = response.data;
                if (questions.length <= 0 && curVal > totalQuestions){

                    //결과화면으로 이동하는 함수
                    setResult();
                }else{
                    testNum.value = curVal + 1;
                    updateProgress(questions, curVal);
                }
            })
            .catch(error => {
                console.error("질문을 불러오는 중 오류 발생:", error);
            });

    }

    // 질문 세팅 함수
    function updateProgress(questions, curVal) {
        let progress = (curVal / totalQuestions) * 100;

        console.log("질문 : " + questions[0].qstn_cn); // 디버깅용
        console.log("답변 1 : " + questions[1].qstn_cn); // 디버깅용
        console.log("답변 2 : " + questions[2].qstn_cn); // 디버깅용
        document.getElementById("progressBar").style.width = progress + "%";
        document.getElementById("progressText").innerText = curVal + "/" + totalQuestions;
        document.getElementById("questionTitle").innerText = "Q" + curVal;
        document.getElementById("questionText").innerText = questions[0].qstn_cn;
        document.getElementById("answerText_1").innerText = questions[1].qstn_cn;
        document.getElementById("answerText_2").innerText = questions[2].qstn_cn;
        document.getElementById("btn_1").setAttribute("data-mbti",questions[1].qstn_ans_mbti);
        document.getElementById("btn_2").setAttribute("data-mbti",questions[2].qstn_ans_mbti);


    }

    //mbti 값 계산 함수
    function setMbti(getMbti){
        let hiddenVal = document.getElementById(getMbti);
        let currentVal = parseInt(hiddenVal.value, 10); // 현재 값 숫자로 변환
        hiddenVal.value = currentVal + 1; // 값 증가
    }

    //결과값 세팅 및 화면 이동 함수
    function setResult(){
        // 모든 hidden input 값을 가져오기
        let params = {
            E: document.getElementById("E").value,
            I: document.getElementById("I").value,
            N: document.getElementById("N").value,
            S: document.getElementById("S").value,
            F: document.getElementById("F").value,
            T: document.getElementById("T").value,
            P: document.getElementById("P").value,
            J: document.getElementById("J").value
        };

        // 데이터를 세션 스토리지에 저장 (먼저 실행해야 함!)
        sessionStorage.setItem("mbti_params", JSON.stringify(params));

        // 로딩 페이지로 이동
        setTimeout(() => {
            window.location.href = "/api/v1/loading";
        }, 500); // 0.5초 딜레이를 추가하여 데이터가 확실히 저장되도록 함

        // Axios를 이용한 POST 요청
        // axios.post('/api/v1/result', params)
        //     .then(response => {
        //         // JSON 데이터 받아오기
        //         const resultMbti = response.data.resultMbti;
        //         const ratio = response.data.ratio;
        //
        //         // 세션 스토리지에 저장 (or localStorage)
        //         sessionStorage.setItem("resultMbti", resultMbti);
        //         sessionStorage.setItem("ratio", ratio);
        //
        //         // 결과 페이지로 이동(임시)
        //         window.location.href = '/api/v1/getMbtiResult';
        //         // 이게 진짜임!!!!!!!!오픈 전에 바꿔야돼 이걸로!!!!!!!!
        //         // window.location.href = '/api/v1/'+resultMbti;
        //     })
        //     .catch(error => {
        //         console.error("MBTI 결과 전송 중 오류 발생:", error);
        //     });
    }
</script>

<body>
<div class="container">
    <!-- 진행률 바 -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <input type="hidden" id="testNum" th:value="2">
    <input type="hidden" id="E" th:value="0">
    <input type="hidden" id="I" th:value="0">
    <input type="hidden" id="N" th:value="0">
    <input type="hidden" id="S" th:value="0">
    <input type="hidden" id="F" th:value="0">
    <input type="hidden" id="T" th:value="0">
    <input type="hidden" id="P" th:value="0">
    <input type="hidden" id="J" th:value="0">

    <!-- 질문 영역 -->
    <div class="question-wrapper">
        <div class="progress-text">
            <h1 id="progressText">1/16</h1>
        </div>
        <p class="question" id="questionText">[[${mbtiQuestion[0]['qstn_cn']}]]</p>
    </div>

    <!-- 버튼 영역 (화면 하단 고정) -->
    <div class="button-section">
        <button class="answer-button" th:id="btn_1" th:data-mbti="${mbtiQuestion[1]['qstn_ans_mbti']}"
                onclick="nextQuestion(this)">
            <span id="answerText_1">[[${mbtiQuestion[1]['qstn_cn']}]]</span>
        </button>
        <button class="answer-button" th:id="btn_2" th:data-mbti="${mbtiQuestion[2]['qstn_ans_mbti']}"
                onclick="nextQuestion(this)">
            <span id="answerText_2">[[${mbtiQuestion[2]['qstn_cn']}]]</span>
        </button>
    </div>
</div>
</body>
</html>
